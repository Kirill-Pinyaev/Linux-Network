Part 1. Инструмент ipcalc
------------------------
1. Поднял виртуальную машину ws1.

![ws1](images/part1.1.png)

2. Устанавил ipcalc `sudo apt install ipcalc`

3. Сети и маски

![ipcalc](images/part1.2.png)

1. адрес сети 192.167.38.54/13
* 192.160.0.0/13
2. Перевод маски 255.255.255.0 в перфиксную и двоичную запись
* /24
* 11111111.11111111.11111111. 00000000
3. Перевод /15 вобычную и двоичную
* 255.254.0.0
* 11111111.11111110.00000000. 00000000
4. Перевод 11111111.11111111.11111111.11110000 в обычную и перфиксную
* 255.255.255.240
* /28
5. Минимальный и максимальный хост в сети 12.167.38.4 /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
* /8: 12.0.0.1 - 12.255.255.254
* 11111111.11111111.00000000.00000000: 12.167.38.1 - 12.167.38.254
* /255.255.254.0: 12.167.38.1 - 12.167.39.254
* /4: 1 - 254

4. localhost
1. Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2,          127.1.0.1, 128.0.0.1
* могут 127.0.0.2, 127.1.0.1
* не могут 194.34.23.100, 128.0.0.1

5. Диапазоны и сегменты сетей
1. Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
* Частные адреса начинаются со следующих чисел 10, 127, 169, 172, 192.
* Частыне: 172.16.255.255, 172.20.250.4, 192.168.4.2, 10.0.0.45, 10.10.10.10
* Публичные: 134.43.0.2, 192.169.168.1,192.172.0.1,172.0.2.1,
2. Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
* 10.10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.1.255

Part 2. Статическая маршрутизация между двумя машинами
------------------------------------------------------

1. С помощью команды ip a посмотреть существующие сетевые интерфейсы

![ws1 ip](images/part2.1.png)

![ws2 ip](images/part2.2.png)

2. Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

![ws1 ip](images/part2.3.png)

![ws2 ip](images/part2.4.png)

3. Выполнить команду `netplan apply` для перезапуска сервиса сети

![ws1 ip](images/part2.5.png)

![ws2 ip](images/part2.6.png)

4. Добавление статического маршрута вручную

1. Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`

![ws1 ip](images/part2.7.png)

![ws2 ip](images/part2.8.png)

2. Пропинговать соединение между машинами

![ws1 ip](images/part2.9.png)

![ws2 ip](images/part2.10.png)

5. Добавление статического маршрута с сохранением

1. Перезапустить машины `reboot`

2. Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

![ws1 ip](images/part2.11.png)

![ws2 ip](images/part2.12.png)

3. Пропинговать соединение между машинами

![ws1 ip](images/part2.13.png)

![ws2 ip](images/part2.14.png)

Part 3. Утилита iperf3
---------------------

1. Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps
* 8 Mbps = 1 MB/s
* 100 MB/s = 819200 Kbps (Kilobit per second)
* 1 Gbps (Gigabit per second) = 1024 Mbps

2. Измерить скорость соединения между ws1 и ws2

![ws1 iperf3](images/part3.1.png)

![ws2 iperf3](images/part3.2.png)

Part 4. Сетевой экран
--------------------

1. Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:
* ws1

![ws1 iptables](images/part4.1.png)
*ws2

![ws2 iptables](images/part4.2.png)

2. Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`

* ws1

![ws1 iptables](images/part4.3.png)
*ws2

![ws2 iptables](images/part4.4.png)

* Разница в том, что если сперва идет запрещающее правило, то оно не перезаписывается потом разрешающим правилом.

3. Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен

![ws nmap](images/part4.5.png)

![ws nmap](images/part4.6.png)


Part 5. Статическая маршрутизация сети
-------------------------------------

1. Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))
2. Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.

![r1](images/part5.r1.png)

![r2](images/part5.r2.png)

![ws11](images/part5.ws11.png)

![ws21](images/part5.ws21.png)

![ws22](images/part5.ws22.png)

3. Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.

![r1](images/part5.r1.1.png)

![r2](images/part5.r2.1.png)

![ws11](images/part5.ws11.1.png)

![ws21](images/part5.ws21.1.png)

![ws22](images/part5.ws22.1.png)

![ping](images/part5.1.png)

![ping](images/part5.2.png)

4. Для включения переадресации IP, выполните команду на роутерах: `sysctl -w net.ipv4.ip_forward=1`

![r1](images/part5.r1.2.png)

![r2](images/part5.r2.2.png)

5. Откройте файл /etc/sysctl.conf и добавьте в него следующую строку: `net.ipv4.ip_forward = 1`

![r1](images/part5.r1.3.png)

![r2](images/part5.r2.3.png)

6. Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 перед IP роутера в файле конфигураций. 

![ws11](images/part5.ws11.2.png)

![ws21](images/part5.ws21.2.png)

![ws22](images/part5.ws22.2.png)

7. Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации

![ws11](images/part5.ws11.3.png)

![ws21](images/part5.ws21.3.png)

![ws22](images/part5.ws22.3.png)

8. Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i enp0s3`

![ping](images/part5.3.png)

![ping](images/part5.4.png)

9. Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.

![r1](images/part5.r1.4.png)

![r2](images/part5.r2.4.png)

10. Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.

![r1](images/part5.r1.5.png)

![r2](images/part5.r2.5.png)

11. Запустить команды на ws11:
`ip r list 10.10.0.0/[18] и ip r list 0.0.0.0/0`

![ws11](images/part5.ws11.4.png)

* Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, поскольку он является адресом сети и доступен без шлюза.

12. Запустить на r1 команду дампа: `tcpdump -tnv -i enp0s3`. При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21

![r1](images/part5.r1.6.png)

![ws11](images/part5.ws11.5.png)

* Путь строиться от узла к узлу до того момента, покаа не будет достигнута конечная точка. Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. На каждом узле добавляется счетчик, который отслеживает количество пройденых узлов.

13. Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i enp0s3 icmp`
Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды: `ping -c 1 10.30.0.111`

![r1](images/part5.r1.7.png)

![ws11](images/part5.ws11.6.png)

Part 6. Динамическая настройка IP с помощью DHCP
------------------------------------------------

1. Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![r2](images/part6.r2.1.png)

2. в файле resolv.conf прописать nameserver 8.8.8.8.

![r2](images/part6.r2.2.png)

3. Перезагрузить службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

![r2](images/part6.r2.3.png)

![ws21](images/part6.ws21.1.png)

4. Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true

![ws11](images/part6.ws11.1.png)

5. Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

![r1](images/part6.r1.1.png)

* в файле resolv.conf прописать nameserver 8.8.8.8.

![r1](images/part6.r1.2.png)

* Перезагрузить службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws11 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес.

![r1](images/part6.r1.3.png)

![ws11](images/part6.ws11.2.png)

6. Запросить с ws21 обновление ip адреса

* до обновления

![ws21](images/part6.ws21.2.png)

* для обновления используем `sudo dhclient -r enp0s3`,  `sudo dhclient enp0s3`

* после обновления

![ws21](images/part6.ws21.3.png)


Part 7. NAT
----------

1. В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным

![r1](images/part7.r1.1.png)

![ws22](images/part7.ws22.1.png)

2. Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

![r1](images/part7.r1.2.png)

![ws22](images/part7.ws22.2.png)

3. Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) удаление правил в таблице filter - iptables -F
2) удаление правил в таблице "NAT" - iptables -F -t nat
3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![firewall](images/part7.1.png)

3. Проверить соединение между ws22 и r1 командой ping

![ws22](images/part7.ws22.3.png)

4. Добавить в файл ещё одно правило:

4) разрешить маршрутизацию всех пакетов протокола ICMP

![firewall](images/part7.2.png)

5. Проверить соединение между ws22 и r1 командой ping

![ws22](images/part7.ws22.4.png)

6. Добавить в файл ещё два правила:

5) включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

6) включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![firewall](images/part7.3.png)

7. Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 

![ws22](images/part7.ws22.5.png)

8. Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)

![r1](images/part7.r1.3.png)

Part 8. Дополнительно. Знакомство с SSH Tunnels
-----------------------------------------------

1. Запустить на r2 фаервол с правилами из Части 7

2. Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

![ws22](images/part8.ws22.1.png)

![ws22](images/part8.ws22.2.png)

3. Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

![ws21](images/part8.ws21.1.png)

4. Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![ws11](images/part8.ws11.1.png)

5. Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2)

![ws11](images/part8.ws11.2.png)

![ws21](images/part8.ws21.2.png)


